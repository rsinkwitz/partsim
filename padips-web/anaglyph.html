<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Three.js Stereo Playground</title>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>

    <!-- IMPORTANT: import map MUST be before module script -->
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
          }
        }
    </script>

</head>
<body>

<script type="module">
    import * as THREE from 'three';
    import { AnaglyphEffect } from 'three/addons/effects/AnaglyphEffect.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

    let scene, camera, renderer, effect, controls, meshes = [];
    let stereo;

    const params = {
      anaglyph: true,
      eyeSeparationMM: 80,   // dein IPD
      wireframe: false,
      scale: 1,
      zPosition: 0
    };

    init();
    animate();

    function init() {

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

    stereo = new THREE.StereoCamera();
    updateStereo();

      camera = new THREE.PerspectiveCamera(
        70,
        window.innerWidth / window.innerHeight,
        0.1,
        100
      );
      camera.position.set(0, 0, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      effect = new AnaglyphEffect(renderer);
      effect.setSize(window.innerWidth, window.innerHeight);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5, 5, 5);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040));

      // 5 verschiedene Objekte mit verschiedenen Farben erstellen
      const objects = [
        {
          geometry: new THREE.BoxGeometry(1.5, 1.5, 1.5),
          color: 0x0000ff, // Blau
          position: { x: -6, y: 0, z: 0 }
        },
        {
          geometry: new THREE.SphereGeometry(0.8, 32, 32),
          color: 0xff0000, // Rot
          position: { x: -3, y: 0, z: 0 }
        },
        {
          geometry: new THREE.TorusKnotGeometry(0.7, 0.25, 128, 32),
          color: 0x00ff00, // Grün
          position: { x: 0, y: 0, z: 0 }
        },
        {
          geometry: new THREE.CylinderGeometry(0.6, 0.6, 1.5, 32),
          color: 0xffff00, // Gelb
          position: { x: 3, y: 0, z: 0 }
        },
        {
          geometry: new THREE.TorusGeometry(0.8, 0.3, 16, 100),
          color: 0xffffff, // Weiß
          position: { x: 6, y: 0, z: 0 }
        }
      ];

      objects.forEach(obj => {
        const material = new THREE.MeshStandardMaterial({
          color: obj.color,
          wireframe: params.wireframe
        });
        const mesh = new THREE.Mesh(obj.geometry, material);
        mesh.position.set(obj.position.x, obj.position.y, obj.position.z + params.zPosition);
        mesh.scale.setScalar(params.scale);
        scene.add(mesh);
        meshes.push(mesh);
      });
      scene.add(new THREE.GridHelper(20, 20));

      const gui = new GUI();
      gui.add(params, 'anaglyph').name('Use Anaglyph');

    gui.add(params, 'eyeSeparationMM', 0, 120, 1)
       .name('Eye Separation (mm)')
       .onChange(updateStereo);

      gui.add(params, 'wireframe')
         .name('Wireframe')
         .onChange(v => {
           meshes.forEach(mesh => mesh.material.wireframe = v);
         });

        gui.add(params, 'scale', 0.2, 3, 0.01)
           .name('Object Scale')
           .onChange(v => {
             meshes.forEach(mesh => mesh.scale.setScalar(v));
           });

        gui.add(params, 'zPosition', -5, 5, 0.01)
           .name('Object Z Position')
           .onChange(v => {
             meshes.forEach(mesh => {
               mesh.position.z = v;
             });
           });

      window.addEventListener('resize', onResize);
    }

    function updateStereo() {
      // Umrechnung mm → Welt-Einheiten
      // 1000mm = 1 Welt-Einheit (Meter-Logik)
      stereo.eyeSep = params.eyeSeparationMM / 1000;
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      effect.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);

      meshes.forEach(mesh => {
        mesh.rotation.y += 0.005;
        mesh.rotation.x += 0.003;
      });

      controls.update();

        if (params.anaglyph) {

          stereo.update(camera);

          renderer.setScissorTest(false);
          renderer.clear();

          effect.render(scene, camera);

        } else {
          renderer.render(scene, camera);
        }

    }
</script>

</body>
</html>